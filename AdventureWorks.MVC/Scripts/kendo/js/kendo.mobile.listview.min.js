/*
* Kendo UI Beta v2012.3.1024 (http://kendoui.com)
* Copyright 2012 Telerik AD. All rights reserved.
*
* Kendo UI Beta license terms available at
* http://www.kendoui.com/purchase/license-agreement/kendo-ui-beta.aspx
*/

;(function(e,t){function k(t){var n=e(t.target).find("input"),r=!n[0].checked;n.is(":radio")&&(r=!0),n.attr("checked",r).trigger("change")}function L(){return this.nodeType===r.TEXT_NODE&&this.nodeValue.match(N)}function A(e,t){t&&e.prepend('<span class="km-icon km-'+t+'"/>')}function O(e){A(e,h(e,"icon"))}function M(e){var t=e.parent(),r=e.add(t.children(n.roleSelector("detailbutton"))),i=t.contents().not(r).not(L);if(i.length)return;e.addClass("km-listview-link").attr(n.attr("role"),"listview-link"),A(e,h(t,"icon"))}function _(e){if(!e.children("input[type=checkbox],input[type=radio]").length)return;var t=e.parent();if(t.contents().not(e).not(function(){return this.nodeType==3})[0])return;e.addClass("km-listview-label")}var n=window.kendo,r=window.Node,i=n.mobile,s=i.ui,o=n.support,u=n.data.DataSource,a=s.Widget,f=".km-list > li, > li",l=".km-listview-link, .km-listview-label",c=e.proxy,h=n.attrValue,p="km-group-title",d="km-state-active",v='<div class="'+p+'"><div class="km-text"></div></div>',m=n.template('<li><div class="'+p+'"><div class="km-text">#= this.headerTemplate(data) #</div></div><ul>#= kendo.render(this.template, data.items)#</ul></li>'),g='<div class="km-listview-wrapper" />',y=".kendoMobileListView",b="lastPageReached",w="click",E=w+y,S="change",x="requestStart",T="function",N=/^\s+$/,C=/button/,D=a.extend({init:function(e,t){var r=this,i;a.fn.init.call(r,e,t),i=r.eventProxy,t=r.options,i.on("down",l,"_highlight").on("move up cancel",l,"_dim").on("up",f,"_click"),o.mobileOS.ios&&i.on("up",".km-listview-label",k),r.element.wrap(g),r.wrapper=r.element.parent(),r._footer(),r._dataSource(),r._bindScroller(),r._fixHeaders(),t.dataSource&&r.options.autoBind?r.dataSource.fetch():r._style(),n.notify(r,s)},events:[w,b],options:{name:"ListView",style:"",type:"flat",autoBind:!0,fixedHeaders:!1,template:"#:data#",headerTemplate:'<span class="km-text">#:value#</span>',appendOnRefresh:!1,loadMore:!1,loadMoreText:"Press to load more",endlessScroll:!1,scrollTreshold:30,pullToRefresh:!1,pullTemplate:"Pull to refresh",releaseTemplate:"Release to refresh",refreshTemplate:"Refreshing",pullOffset:140},setOptions:function(e){a.fn.setOptions.call(this,e)},setDataSource:function(e){this.options.dataSource=e,this._dataSource(),this.options.autoBind&&e.fetch()},destroy:function(){var e=this;a.fn.destroy.call(e),e._unbindDataSource(),e.stopEndlessScrolling(),e.stopLoadMore(),n.destroy(e.element)},refresh:function(t){t=t||{};var r=this,o=r.element,u=r.options,a=r.dataSource,f=a.view(),l=r.loading,c="html",h,p,d;if(t.action==="itemchange"){p=t.items[0],d=e(r.template(p)),o.find("[data-"+n.ns+"uid="+p.uid+"]").replaceWith(d),r.trigger("itemChange",{item:d,data:p,ns:s}),r._style();return}r.template||r._templates(),r._cacheDataItems(f),r.trigger("dataBinding"),a.group()[0]?(u.type="group",h=n.render(r.groupTemplate,f)):h=n.render(r.template,f),l?c="append":u.appendOnRefresh&&(c="prepend"),o[c](h),l&&(r.loading=!1,r._calcTreshold(),r._toggleLoader(!1)),u.pullToRefresh&&r._scroller().pullHandled(),i.init(o.children()),r._hideLoading(),r._shouldFixHeaders(),r._style(),r.trigger("dataBound",{ns:s})},_cacheDataItems:function(e){var t=this,n;t.element[0].firstChild||(t._firstOrigin=t._first=e[0],t._last=e[e.length-1]),t._pulled&&(n=e[0],t._pulled=!1,n&&(t._first=n)),t.loading&&(n=e[e.length-1],n&&(t._last=n))},items:function(){return this.options.type==="group"?this.element.find(".km-list").children():this.element.children()},stopEndlessScrolling:function(){var e=this,t=e._scroller();t&&e._loadIcon&&(e.loading=!1,e._loadIcon.parent().hide(),t.unbind("resize",e._scrollerResize).unbind("scroll",e._scrollerScroll),e.trigger(b))},stopLoadMore:function(){var e=this;e._loadButton&&(e.loading=!1,e._loadButton.off(E).parent().hide(),e.trigger(b))},_dim:function(e){this._toggle(e,!1)},_highlight:function(e){this._toggle(e,!0)},_toggle:function(t,n){if(t.which>1)return;var r=e(t.currentTarget),i=r.parent(),s=h(r,"role")||"",o=!s.match(C),u=t.isDefaultPrevented();o&&i.toggleClass(d,n&&!u)},_unbindDataSource:function(){var e=this;e.dataSource.unbind(S,e._refreshHandler).unbind(x,e._requestStartHandler)},_dataSource:function(){var e=this,t=e.options;e.dataSource&&e._refreshHandler?e._unbindDataSource():(e._refreshHandler=c(e.refresh,e),e._requestStartHandler=c(e._showLoading,e)),e.dataSource=u.create(t.dataSource).bind(S,e._refreshHandler),!t.pullToRefresh&&!t.loadMore&&!t.endlessScroll&&e.dataSource.bind(x,e._requestStartHandler)},_fixHeader:function(t){var n=0,r=this,i=r._scroller(),s=t.scrollTop,o=r.headers,u,a,f;if(r.fixedHeaders){do{u=o[n++];if(!u){f=e("<div />");break}a=u.offset,f=u.header}while(a>s);r.currentHeader!=n&&(i.fixedContainer.html(f.clone()),r.currentHeader=n)}},_shouldFixHeaders:function(){this.fixedHeaders=this.options.type==="group"&&this.options.fixedHeaders},_cacheHeaders:function(){var t=this,n=[];t.fixedHeaders&&(t.element.find("."+p).each(function(t,r){r=e(r),n.unshift({offset:r.position().top,header:r})}),t.headers=n,t._fixHeader({scrollTop:0}))},_fixHeaders:function(){var e=this,t=e._scroller();e._shouldFixHeaders(),t&&(n.onResize(function(){e._cacheHeaders()}),t.bind("scroll",function(t){e._fixHeader(t)}))},_bindScroller:function(){var e=this,t=e.options,n=e.dataSource,r=e._scroller();if(!r)return;t.pullToRefresh&&r.setOptions({pullToRefresh:!0,pull:function(){var r=t.pullParameters,i={page:1};r&&(i=r.call(e,e._first)),e._pulled=!0,n.read(i)},pullTemplate:t.pullTemplate,releaseTemplate:t.releaseTemplate,refreshTemplate:t.refreshTemplate}),t.endlessScroll&&(e._scrollHeight=r.element.height(),e._scrollerResize=function(){e._scrollHeight=r.element.height(),e._calcTreshold()},e._scrollerScroll=function(t){!e.loading&&t.scrollTop+e._scrollHeight>e._treshold&&e._nextPage()},r.setOptions({resize:e._scrollerResize,scroll:e._scrollerScroll}))},_calcTreshold:function(){var e=this,t=e._scroller();t&&(e._treshold=t.scrollHeight()-e.options.scrollTreshold)},_nextPage:function(){var e=this,t=e.options,n=t.endlessScrollParameters||t.loadMoreParameters,r;e.loading=!0,e._toggleLoader(!0),n&&(r=n.call(e,e._firstOrigin,e._last)),e.dataSource.next(r)||(e.stopLoadMore(),e.stopEndlessScrolling())},_templates:function(){var e=this,t=e.options.template,r=e.options.headerTemplate,i=' data-uid="#=data.uid || ""#"',s={},o={};typeof t===T&&(s.template=t,t="#=this.template(data)#"),o.template=e.template=c(n.template("<li"+i+">"+t+"</li>"),s),typeof r===T&&(o._headerTemplate=r,r="#=this._headerTemplate(data)#"),o.headerTemplate=n.template(r),e.groupTemplate=c(m,o)},_click:function(t){if(t.which>1||t.isDefaultPrevented())return;var r=this,i,o=e(t.currentTarget),u=e(t.target),a=u.closest(n.roleSelector("button","detailbutton","backbutton")),f=n.widgetInstance(a,s),l=o.attr(n.attr("uid"));l&&(i=r.dataSource.getByUid(l)),r.trigger(w,{target:u,item:o,dataItem:i,button:f})&&t.preventDefault()},_style:function(){var t=this,n=t.options,r=n.type==="group",i=t.element,s=n.style==="inset";i.addClass("km-listview").toggleClass("km-list",!r).toggleClass("km-listinset",!r&&s).toggleClass("km-listgroup",r&&!s).toggleClass("km-listgroupinset",r&&s),r&&(i.children().children("ul").addClass("km-list"),i.children("li").each(function(){var t=e(this).contents().first();!t.is("ul")&&!t.is("div."+p)&&t.wrap(v)})),t._enhanceItems(),i.parents(".km-listview")[0]||i.closest(".km-content").toggleClass("km-insetcontent",s),t._cacheHeaders()},_enhanceItems:function(){this.items().each(function(){var t=e(this),n,r=!1;t.children().each(function(){n=e(this),n.is("a")?(M(n),r=!0):n.is("label")&&(_(n),r=!0)}),r||O(t)})},_footer:function(){var t=this,n=t.options,r=n.loadMore,i;if(r||n.endlessScroll)t._loadIcon=e('<span style="display:none" class="km-icon"></span>'),i=e('<span class="km-load-more"></span>').append(t._loadIcon),r&&(t._loadButton=e('<button class="km-load km-button">'+n.loadMoreText+"</button>").on(E,c(t._nextPage,t)),i.append(t._loadButton)),t.wrapper.append(i)},_toggleLoader:function(e){var t=this,n=t._loadIcon,r=t._loadButton;r&&r.toggle(!e),e?n.css("display","block"):n.hide()},_scroller:function(){var e=this,t;return e._scrollerInstance||(t=e.view(),e._scrollerInstance=t&&t.scroller),e._scrollerInstance},_showLoading:function(){var e=this.view();e&&e.loader.show()},_hideLoading:function(){var e=this.view();e&&e.loader.hide()}});s.plugin(D)})(jQuery);