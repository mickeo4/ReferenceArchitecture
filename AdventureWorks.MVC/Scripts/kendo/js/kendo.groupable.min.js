/*
* Kendo UI Beta v2012.3.1024 (http://kendoui.com)
* Copyright 2012 Telerik AD. All rights reserved.
*
* Kendo UI Beta license terms available at
* http://www.kendoui.com/purchase/license-agreement/kendo-ui-beta.aspx
*/

;(function(e,t){function l(e){return e.position().top+3}var n=window.kendo,r=n.ui.Widget,i=e.proxy,s=".kendoGroupable",o=n.template('<div class="k-group-indicator" data-#=data.ns#field="${data.field}" data-#=data.ns#title="${data.title || ""}" data-#=data.ns#dir="${data.dir || "asc"}"><a href="\\#" class="k-link"><span class="k-icon k-si-arrow-${(data.dir || "asc") == "asc" ? "n" : "s"}">(sorted ${(data.dir || "asc") == "asc" ? "ascending": "descending"})</span>${data.title ? data.title: data.field}</a><a class="k-button k-button-icon k-button-bare"><span class="k-icon k-group-delete"></span></a></div>',{useWithBlock:!1}),u=function(t){return e('<div class="k-header k-drag-clue" />').css({width:t.width(),paddingLeft:t.css("paddingLeft"),paddingRight:t.css("paddingRight"),lineHeight:t.height()+"px",paddingTop:t.css("paddingTop"),paddingBottom:t.css("paddingBottom")}).html(t.attr(n.attr("title"))||t.attr(n.attr("field"))).prepend('<span class="k-icon k-drag-status k-denied" />')},a=e('<div class="k-grouping-dropclue"/>'),f=/(\[|\]|\$|\.|\:|\+)/g,c=r.extend({init:function(t,o){var f=this,c,h=n.guid(),p=i(f._intializePositions,f),d,v=f._dropCuePositions=[];r.fn.init.call(f,t,o),d=f.options.draggable||new n.ui.Draggable(f.element,{filter:f.options.filter,hint:u,group:h}),c=f.groupContainer=e(f.options.groupContainer,f.element).kendoDropTarget({group:d.options.group,dragenter:function(e){f._canDrag(e.draggable.currentTarget)&&(e.draggable.hint.find(".k-drag-status").removeClass("k-denied").addClass("k-add"),a.css({top:l(c),left:0}).appendTo(c))},dragleave:function(e){e.draggable.hint.find(".k-drag-status").removeClass("k-add").addClass("k-denied"),a.remove()},drop:function(t){var r=t.draggable.currentTarget,i=r.attr(n.attr("field")),s=r.attr(n.attr("title")),o=f.indicator(i),u=f._dropCuePositions,l=u[u.length-1],c;if(!r.hasClass("k-group-indicator")&&!f._canDrag(r))return;l?(c=f._dropCuePosition(a.offset().left+parseInt(l.element.css("marginLeft"),10)+parseInt(l.element.css("marginRight"),10)),c&&f._canDrop(e(o),c.element,c.left)&&(c.before?c.element.before(o||f.buildIndicator(i,s)):c.element.after(o||f.buildIndicator(i,s)),f._change())):(f.groupContainer.append(f.buildIndicator(i,s)),f._change())}}).kendoDraggable({filter:"div.k-group-indicator",hint:u,group:d.options.group,dragcancel:i(f._dragCancel,f),dragstart:function(e){var t=e.currentTarget,n=parseInt(t.css("marginLeft"),10),r=t.position().left-n;p(),a.css({top:l(c),left:r}).appendTo(c),this.hint.find(".k-drag-status").removeClass("k-denied").addClass("k-add")},dragend:function(){f._dragEnd(this)},drag:i(f._drag,f)}).on("click"+s,".k-button",function(t){t.preventDefault(),f._removeIndicator(e(this).parent())}).on("click"+s,".k-link",function(t){var r=e(this).parent(),i=f.buildIndicator(r.attr(n.attr("field")),r.attr(n.attr("title")),r.attr(n.attr("dir"))=="asc"?"desc":"asc");r.before(i).remove(),f._change(),t.preventDefault()}),d.bind(["dragend","dragcancel","dragstart","drag"],{dragend:function(){f._dragEnd(this)},dragcancel:i(f._dragCancel,f),dragstart:function(e){var t,n,r;if(!f.options.allowDrag&&!f._canDrag(e.currentTarget)){e.preventDefault();return}p(),v.length?(t=v[v.length-1].element,n=parseInt(t.css("marginRight"),10),r=t.position().left+t.outerWidth()+n):r=0},drag:i(f._drag,f)}),f.dataSource=f.options.dataSource,f.dataSource&&(f._refreshHandler=i(f.refresh,f),f.dataSource.bind("change",f._refreshHandler))},refresh:function(){var t=this,r=t.dataSource;t.groupContainer.empty().append(e.map(r.group()||[],function(e){var r=e.field.replace(f,"\\$1"),i=t.element.find(t.options.filter).filter("["+n.attr("field")+"="+r+"]");return t.buildIndicator(e.field,i.attr(n.attr("title")),e.dir)}).join("")),t._invalidateGroupContainer()},destroy:function(){var e=this;r.fn.destroy.call(e),e.groupContainer.off(s).kendoDraggable("destroy"),e.dataSource&&e._refreshHandler&&e.dataSource.unbind("change",e._refreshHandler)},options:{name:"Groupable",filter:"th",messages:{empty:"Drag a column header and drop it here to group by that column"}},indicator:function(t){var r=e(".k-group-indicator",this.groupContainer);return e.grep(r,function(r){return e(r).attr(n.attr("field"))===t})[0]},buildIndicator:function(e,t,r){return o({field:e,dir:r,title:t,ns:n.ns})},descriptors:function(){var t=this,r=e(".k-group-indicator",t.groupContainer),i,s,o,u,a;return i=t.element.find(t.options.filter).map(function(){var t=e(this),r=t.attr(n.attr("aggregates")),i=t.attr(n.attr("field"));if(r&&r!==""){s=r.split(","),r=[];for(u=0,a=s.length;u<a;u++)r.push({field:i,aggregate:s[u]})}return r}).toArray(),e.map(r,function(t){return t=e(t),o=t.attr(n.attr("field")),{field:o,dir:t.attr(n.attr("dir")),aggregates:i||[]}})},_removeIndicator:function(e){var t=this;e.remove(),t._invalidateGroupContainer(),t._change()},_change:function(){var e=this;e.dataSource&&e.dataSource.group(e.descriptors())},_dropCuePosition:function(t){var n=this._dropCuePositions;if(!a.is(":visible")||n.length===0)return;t=Math.ceil(t);var r=n[n.length-1],i=r.right,s=parseInt(r.element.css("marginLeft"),10),o=parseInt(r.element.css("marginRight"),10);return t>=i?t={left:r.element.position().left+r.element.outerWidth()+o,element:r.element,before:!1}:(t=e.grep(n,function(e){return e.left<=t&&t<=e.right})[0],t&&(t={left:t.element.position().left-s,element:t.element,before:!0})),t},_drag:function(e){var t=n.touchLocation(e),r=this._dropCuePosition(t.x);r&&a.css({left:r.left})},_canDrag:function(e){var t=e.attr(n.attr("field"));return e.attr(n.attr("groupable"))!="false"&&t&&(e.hasClass("k-group-indicator")||!this.indicator(t))},_canDrop:function(e,t,n){var r=e.next();return e[0]!==t[0]&&(!r[0]||t[0]!==r[0]||n>r.position().left)},_dragEnd:function(t){var r=this,i=t.currentTarget.attr(n.attr("field")),s=r.indicator(i);t!==r.options.draggable&&!t.dropped&&s&&r._removeIndicator(e(s)),r._dragCancel()},_dragCancel:function(){a.remove(),this._dropCuePositions=[]},_intializePositions:function(){var t=this,n=e(".k-group-indicator",t.groupContainer),r;t._dropCuePositions=e.map(n,function(t){return t=e(t),r=t.offset().left,{left:parseInt(r,10),right:parseInt(r+t.outerWidth(),10),element:t}})},_invalidateGroupContainer:function(){var e=this.groupContainer;e.is(":empty")&&e.html(this.options.messages.empty)}});n.ui.plugin(c)})(jQuery);