/*
* Kendo UI Beta v2012.3.1024 (http://kendoui.com)
* Copyright 2012 Telerik AD. All rights reserved.
*
* Kendo UI Beta license terms available at
* http://www.kendoui.com/purchase/license-agreement/kendo-ui-beta.aspx
*/

;(function(e,t){function N(e,t){var n=e[t];return i(n)?n.field||t:n}function C(e,n){if(e===t||!e.match(/\/$/))e=(e||"")+"/";return e+n}function k(e){if(!e)return"";var t=" bytes";return e>=1073741824?(t=" GB",e/=1073741824):e>=1048576?(t=" MB",e/=1048576):e>=1024&&(t=" KB",e/=1024),Math.round(e*100)/100+t}var n=window.kendo,r=n.ui.Widget,i=e.isPlainObject,s=e.proxy,o=e.extend,u=n.support.placeholder,a=e.isFunction,f=/(^\/|\/$)/g,l="change",c="apply",h="error",p="click",d=".kendoImageBrowser",v=".kendoBreadcrumbs",m=".kendoSearchBox",g="name",y="size",b="type",w={field:b,dir:"asc"},E=n.template('<li data-#=ns#value="#=value#" class="k-item">${text}</li>'),S=n.template('<li class="k-tile-empty"><strong>${text}</strong></li>'),x='<div class="k-widget k-toolbar k-floatwrap"><div class="k-toolbar-wrap">#if(showUpload) { # <div class="k-widget k-upload"><div class="k-button k-button-icontext k-button-bare k-upload-button"><span class="k-icon k-add"></span>#=messages.uploadFile#<input type="file" name="file" /></div></div>#}##if(showCreate) {#<button type="button" class="k-button k-button-icon k-button-bare"><span class="k-icon k-addfolder"></span></button>#}##if(showDelete) {#<button type="button" class="k-button k-button-icon k-button-bare k-state-disabled"><span class="k-icon k-delete"></span></button>&nbsp;#}#</div><div class="k-tiles-arrange">#=messages.orderBy#: <a href="\\#" class="k-link"><span>#=messages.orderByName#</span><span class="k-icon k-i-arrow-s"></span></a></div></div>';o(!0,n.data,{schemas:{imagebrowser:{data:function(e){return e.items||e||[]},model:{id:"name",fields:{name:"name",size:"size",type:"type"}}}}}),o(!0,n.data,{transports:{imagebrowser:n.data.RemoteTransport.extend({init:function(t){n.data.RemoteTransport.fn.init.call(this,e.extend(!0,{},this.options,t))},_call:function(t,r){r.data=e.extend({},r.data,{path:this.options.path()}),a(this.options[t])?this.options[t].call(this,r):n.data.RemoteTransport.fn[t].call(this,r)},read:function(e){this._call("read",e)},create:function(e){this._call("create",e)},destroy:function(e){this._call("destroy",e)},update:function(){},options:{read:{type:"POST"},update:{type:"POST"},create:{type:"POST"},destroy:{type:"POST"}}})}});var T;e.browser.msie&&parseFloat(e.browser.version)<8?T=function(e){return e.offsetTop}:T=function(t){return t.offsetTop-e(t).height()};var L=r.extend({init:function(e,t){var n=this;t=t||{},r.fn.init.call(n,e,t),n.element.addClass("k-imagebrowser"),n.element.on(p+d,".k-toolbar button:not(.k-state-disabled):has(.k-delete)",s(n._deleteClick,n)).on(p+d,".k-toolbar button:not(.k-state-disabled):has(.k-addfolder)",s(n._addClick,n)).on("keydown"+d,"li.k-state-selected input",s(n._directoryKeyDown,n)).on("blur"+d,"li.k-state-selected input",s(n._directoryBlur,n)),n._dataSource(),n.refresh(),n.path(n.options.path)},options:{name:"ImageBrowser",messages:{uploadFile:"Upload",orderBy:"Arrange by",orderByName:"Name",orderBySize:"Size",directoryNotFound:"A directory with this name was not found.",emptyFolder:"Empty Folder",deleteFile:'Are you sure you want to delete "{0}"?',invalidFileType:'The selected file "{0}" is not valid. Supported file types are {1}.',overwriteFile:'A file with name "{0}" already exists in the current directory. Do you want to overwrite it?'},transport:{},path:"/",fileTypes:"*.png,*.gif,*.jpg,*.jpeg"},events:[h,l,c],destroy:function(){var e=this;r.fn.destroy.call(e),e.dataSource.unbind(h,e._errorHandler),e.element.add(e.list).add(e.toolbar).off(d),e.arrangeByPopup&&e.arrangeByPopup.destroy(),n.destroy(e.element)},value:function(){var e=this,t=e._selectedItem(),r,i=e.options.transport.imageUrl;if(t&&t.get(e._getFieldName(b))==="f")return r=C(e.path(),t.get(e._getFieldName(g))).replace(f,""),i&&(r=a(i)?i(r):n.format(i,r)),r},_selectedItem:function(){var e=this.listView,t=e.select();if(t.length)return this.dataSource.getByUid(t.attr(n.attr("uid")))},_toolbar:function(){var t=this,r=n.template(x),i=t.options.messages,o,u,a=[{text:i.orderByName,value:"name",ns:n.ns},{text:i.orderBySize,value:"size",ns:n.ns}];t.toolbar=e(r({messages:i,showUpload:t.options.transport.uploadUrl,showCreate:t.options.transport.create,showDelete:t.options.transport.destroy})).appendTo(t.element).find(".k-upload input").kendoUpload({multiple:!1,async:{saveUrl:t.options.transport.uploadUrl,autoUpload:!0},upload:s(t._fileUpload,t)}).end(),t.upload=t.toolbar.find(".k-upload input").data("kendoUpload"),o=t.toolbar.find(".k-tiles-arrange a"),t.arrangeByPopup=u=e("<ul>"+n.render(E,a)+"</ul>").kendoPopup({anchor:o}).on(p+d,"li",function(){var r=e(this),i=r.attr(n.attr("value"));t.toolbar.find(".k-tiles-arrange a span:first").html(r.text()),u.close(),t.orderBy(i)}).data("kendoPopup"),o.on(p+d,function(e){e.preventDefault(),u.toggle()})},_deleteClick:function(){var e=this,t=e.listView.select(),r=n.format(e.options.messages.deleteFile,t.find("strong").text());t.length&&e._showMessage(r,"confirm")&&e.listView.remove(t)},_addClick:function(){this.createDirectory()},_fileUpload:function(e){var t=this,r=t.options,i=r.fileTypes,s=new RegExp(("("+i.split(",").join(")|(")+")").replace(/\*\./g,".*."),"i"),o=e.files[0].name,u=t._getFieldName(g),a=t._getFieldName(y),f;s.test(o)?(e.data={path:t.path()},f=t._createFile(o),f?t.upload.one("success",function(e){f.set(u,e.response[u]),f.set(a,e.response[a]),t._tiles=t.listView.items().filter("["+n.attr("type")+"=f]")}):e.preventDefault()):(e.preventDefault(),t._showMessage(n.format(r.messages.invalidFileType,o,i)))},_findFile:function(e){var t=this.dataSource.data(),n,r,i=this._getFieldName(b),s=this._getFieldName(g),o;e=e.toLowerCase();for(n=0,o=t.length;n<o;n++)if(t[n].get(i)==="f"&&t[n].get(s).toLowerCase()===e){r=t[n];break}return r},_createFile:function(e){var t=this,r,i,s=0,o={},u=t._getFieldName(b),a=t.dataSource.view(),f=t._findFile(e);if(f&&!t._showMessage(n.format(t.options.messages.overwriteFile,e),"confirm"))return null;if(f)return f;for(r=0,i=a.length;r<i;r++)if(a[r].get(u)==="f"){s=r;break}return o[u]="f",o[t._getFieldName(g)]=e,o[t._getFieldName(y)]=0,t.dataSource.insert(++s,o)},createDirectory:function(){var e=this,t,r,i=0,s=e._getFieldName(b),o=e._getFieldName(g),u=e.dataSource.data(),a=e._nameDirectory(),f=new e.dataSource.reader.model;for(t=0,r=u.length;t<r;t++)u[t].get(s)==="d"&&(i=t);f.set(s,"d"),f.set(o,a),e.listView.one("dataBound",function(){var t=e.listView.items().filter("["+n.attr("uid")+"="+f.uid+"]"),r=t.find("input");t.length&&this.edit(t),this.element.scrollTop(t.attr("offsetTop")-this.element[0].offsetHeight),setTimeout(function(){r.select()})}).one("save",function(t){var n=t.model.get(o);n?t.model.set(o,e._nameExists(n,f.uid)?e._nameDirectory():n):t.model.set(o,a)}),e.dataSource.insert(++i,f)},_directoryKeyDown:function(e){e.keyCode==13&&e.currentTarget.blur()},_directoryBlur:function(e){this.listView.save()},_nameExists:function(e,t){var n=this.dataSource.data(),r=this._getFieldName(b),i=this._getFieldName(g),s,o;for(s=0,o=n.length;s<o;s++)if(n[s].get(r)==="d"&&n[s].get(i).toLowerCase()===e.toLowerCase()&&n[s].uid!==t)return!0;return!1},_nameDirectory:function(){var t="New folder",n=this.dataSource.data(),r=[],i=this._getFieldName(b),s=this._getFieldName(g),o,u,a;for(u=0,a=n.length;u<a;u++)n[u].get(i)==="d"&&n[u].get(s).toLowerCase().indexOf(t.toLowerCase())>-1&&r.push(n[u].get(s));if(e.inArray(t,r)>-1){u=2;do o=t+" ("+u+")",u++;while(e.inArray(o,r)>-1);t=o}return t},orderBy:function(e){this.dataSource.sort([{field:this._getFieldName(b),dir:"asc"},{field:this._getFieldName(e),dir:"asc"}])},search:function(e){this.dataSource.filter({field:this._getFieldName(g),operator:"contains",value:e})},_content:function(){var t=this;t.list=e('<ul class="k-reset k-floats k-tiles" />').appendTo(t.element).on("scroll"+d,s(t._scroll,t)).on("dblclick"+d,"li",s(t._dblClick,t)),t.listView=new n.ui.ListView(t.list,{dataSource:t.dataSource,template:t._itemTmpl(),editTemplate:t._editTmpl(),selectable:!0,autoBind:!1,dataBinding:function(e){t.toolbar.find(".k-delete").parent().addClass("k-state-disabled"),(e.action==="remove"||e.action==="sync")&&e.preventDefault()},dataBound:function(){t.dataSource.view().length?(t._tiles=this.items().filter("["+n.attr("type")+"=f]"),t._scroll()):this.wrapper.append(S({text:t.options.messages.emptyFolder}))},change:s(t._listViewChange,t)})},_dblClick:function(t){var r=this,i=e(t.currentTarget);if(i.filter("["+n.attr("type")+"=d]").length){var s=r.dataSource.getByUid(i.attr(n.attr("uid")));s&&(r.path(C(r.path(),s.get(r._getFieldName(g)))),r.breadcrumbs.value(r.path()))}else i.filter("["+n.attr("type")+"=f]").length&&r.trigger(c)},_listViewChange:function(){var e=this._selectedItem();this.toolbar.find(".k-delete").parent().removeClass("k-state-disabled"),e&&e.get(this._getFieldName(b))==="f"&&this.trigger(l)},_dataSource:function(){var e=this,t=e.options,r=t.transport,u=o({},w),a,f={type:r.type||"imagebrowser",sort:u};i(r)&&(r.path=s(e.path,e),f.transport=r),i(t.schema)?(f.schema=t.schema,i(t.schema.model)&&t.schema.model.fields&&(u.field=N(t.schema.model.fields,b))):r.type&&i(n.data.schemas[r.type])&&(a=n.data.schemas[r.type],i(a.model)&&a.model.fields&&(u.field=N(a.model.fields,b))),e.dataSource&&e._errorHandler?e.dataSource.unbind(h,e._errorHandler):e._errorHandler=s(e._error,e),e.dataSource=n.data.DataSource.create(f).bind(h,e._errorHandler)},_navigation:function(){var t=this,n=e('<div class="k-floatwrap"><input/><input/></div>').appendTo(this.element);t.breadcrumbs=n.find("input:first").kendoBreadcrumbs({value:t.options.path,change:function(){t.path(this.value())}}).data("kendoBreadcrumbs"),t.searchBox=n.parent().find("input:last").kendoSearchBox({change:function(){t.search(this.value())}}).data("kendoSearchBox")},_error:function(e){var t=this,n;t.trigger(h,e)||(n=e.xhr.status,e.status=="error"?n=="404"?t._showMessage(t.options.messages.directoryNotFound):n!="0"&&t._showMessage("Error! The requested URL returned "+n+" - "+e.xhr.statusText):n=="timeout"&&t._showMessage("Error! Server timeout."))},_showMessage:function(e,t){return window[t||"alert"](e)},refresh:function(){var e=this;e._navigation(),e._toolbar(),e._content()},_loadImage:function(t){var r=this,i=e(t),s=r.dataSource.getByUid(i.attr(n.attr("uid"))),o=s.get(r._getFieldName(g)),u=e("<img />",{alt:o}).hide().on("load"+d,function(){e(this).prev().remove().end().addClass("k-image").fadeIn()});i.find(".k-loading").after(u),u.attr("src",r.options.transport.thumbnailUrl+"?path="+r.path()+encodeURIComponent(o)),t.loaded=!0},_scroll:function(e){var t=this;t.options.transport&&t.options.transport.thumbnailUrl&&(clearTimeout(t._timeout),t._timeout=setTimeout(function(){var e=t.list.outerHeight(),n=t.list.scrollTop(),r=n+e;t._tiles.each(function(){var e=T(this),i=e+this.offsetHeight;(e>=n&&e<r||i>=n&&i<r)&&t._loadImage(this);if(e>r)return!1}),t._tiles=t._tiles.filter(function(){return!this.loaded})},250))},_editTmpl:function(){var e=this,t='<li class="k-tile k-state-selected" '+n.attr("uid")+'="#=uid#" ';return t+=n.attr("type")+'="${'+e._getFieldName(b)+'}">',t+="#if("+e._getFieldName(b)+' == "d") { #',t+='<div class="k-thumb"><span class="k-icon k-folder"></span></div>',t+="#}else{#",t+='<div class="k-thumb"><span class="k-icon k-loading"></span></div>',t+="#}#",t+="#if("+e._getFieldName(b)+' == "d") { #',t+='<input class="k-input" '+n.attr("bind")+'="value:'+e._getFieldName(g)+'"/>',t+="#}#",t+="</li>",s(n.template(t),{sizeFormatter:k})},_itemTmpl:function(){var e=this,t='<li class="k-tile" '+n.attr("uid")+'="#=uid#" ';return t+=n.attr("type")+'="${'+e._getFieldName(b)+'}">',t+="#if("+e._getFieldName(b)+' == "d") { #',t+='<div class="k-thumb"><span class="k-icon k-folder"></span></div>',t+="#}else{#",e.options.transport&&e.options.transport.thumbnailUrl?t+='<div class="k-thumb"><span class="k-icon k-loading"></span></div>':t+='<div class="k-thumb"><span class="k-icon k-file"></span></div>',t+="#}#",t+="<strong>${"+e._getFieldName(g)+"}</strong>",t+="#if("+e._getFieldName(b)+' == "f") { # <span class="k-filesize">${this.sizeFormatter('+e._getFieldName(y)+")}</span> #}#",t+="</li>",s(n.template(t),{sizeFormatter:k})},_getFieldName:function(e){return N(this.dataSource.reader.model.fields,e)},path:function(e){var n=this,r=n._path||"";if(e!==t){n._path=e.replace(f,"")+"/",n.dataSource.read({path:n._path});return}return r&&(r=r.replace(f,"")),r==="/"||r===""?"":r+"/"}}),A=r.extend({init:function(e,t){var n=this;t=t||{},r.fn.init.call(n,e,t),u&&n.element.attr("placeholder",n.options.label),n._wrapper(),n.element.on("keydown"+m,s(n._keydown,n)).on("change"+m,s(n._updateValue,n)),n.wrapper.on(p+m,"a",s(n._click,n)),u||n.element.on("focus"+m,s(n._focus,n)).on("blur"+m,s(n._blur,n))},options:{name:"SearchBox",label:"Search",value:""},events:[l],destroy:function(){var e=this;e.wrapper.add(e.element).add(e.label).off(m),r.fn.destroy.call(e)},_keydown:function(e){e.keyCode===13&&this._updateValue()},_click:function(e){e.preventDefault(),this._updateValue()},_updateValue:function(){var e=this,t=e.element.val();t!==e.value()&&(e.value(t),e.trigger(l))},_blur:function(){this._updateValue(),this._toggleLabel()},_toggleLabel:function(){u||this.label.toggle(!this.element.val())},_focus:function(){this.label.hide()},_wrapper:function(){var t=this.element,n=t.parents(".k-search-wrap");t[0].style.width="",t.addClass("k-input k-textbox"),n.length||(n=t.wrap(e('<div class="k-widget k-search-wrap k-textbox"/>')).parent(),u||e('<label style="display:block">'+this.options.label+"</label>").insertBefore(t),e('<a href="#" class="k-icon k-i-search k-search"/>').appendTo(n)),this.wrapper=n,this.label=n.find(">label")},value:function(e){var n=this;if(e!==t){n.options.value=e,n.element.val(e),n._toggleLabel();return}return n.options.value}}),O=r.extend({init:function(e,t){var n=this;t=t||{},r.fn.init.call(n,e,t),n._wrapper(),n.wrapper.on("focus"+v,"input",s(n._focus,n)).on("blur"+v,"input",s(n._blur,n)).on("keydown"+v,"input",s(n._keydown,n)).on(p+v,"a.k-i-arrow-n:first",s(n._rootClick,n)).on(p+v,"a:not(.k-i-arrow-n)",s(n._click,n)),n.value(n.options.value)},options:{name:"Breadcrumbs",gap:50},events:[l],destroy:function(){var e=this;r.fn.destroy.call(e),e.wrapper.add(e.wrapper.find("input")).add(e.wrapper.find("a")).off(v)},_update:function(e){e=(e||"").charAt(0)==="/"?e:"/"+(e||""),e!==this.value()&&(this.value(e),this.trigger(l))},_click:function(t){t.preventDefault(),this._update(this._path(e(t.target).prevAll("a:not(.k-i-arrow-n)").andSelf()))},_rootClick:function(e){e.preventDefault(),this._update("")},_focus:function(){var e=this,t=e.element;e.overlay.hide(),e.element.val(e.value()),setTimeout(function(){t.select()})},_blur:function(){if(this.overlay.is(":visible"))return;var e=this,t=e.element,n=t.val().replace(/\/{2,}/g,"/");e.overlay.show(),t.val(""),e._update(n)},_keydown:function(e){var t=this;e.keyCode===13&&(t._blur(),setTimeout(function(){t.overlay.find("a:first").focus()}))},_wrapper:function(){var t=this.element,n=t.parents(".k-breadcrumbs"),r;t[0].style.width="",t.addClass("k-input"),n.length||(n=t.wrap(e('<div class="k-widget k-breadcrumbs k-header k-state-default"/>')).parent()),r=n.find(".k-breadcrumbs-wrap"),r.length||(r=e('<div class="k-breadcrumbs-wrap"/>').appendTo(n)),this.wrapper=n,this.overlay=r},refresh:function(){var n="",r=this.value(),i,s,o,u;if(r===t||!r.match(/^\//))r="/"+(r||"");i=r.split("/");for(o=0,u=i.length;o<u;o++)s=i[o],s&&(n||(n+='<a href="#" class="k-icon k-i-arrow-n">root</a>'),n+='<a class="k-link" href="#">'+i[o]+"</a>",n+='<span class="k-icon k-i-arrow-e">&gt;</span>');this.overlay.empty().append(e(n)),this._adjustSectionWidth()},_adjustSectionWidth:function(){var t=this,n=t.wrapper,r=n.width()-t.options.gap,i=t.overlay.find("a"),s;i.each(function(t){s=e(this),s.parent().width()>r&&(t==i.length-1?s.width(r):s.prev().andSelf().hide())})},value:function(e){if(e!==t){this._value=e.replace(/\/{2,}/g,"/"),this.refresh();return}return this._value},_path:function(t){return"/"+e.map(t,function(t){return e(t).text()}).join("/")}});n.ui.plugin(L),n.ui.plugin(O),n.ui.plugin(A)})(jQuery);