/*
* Kendo UI Beta v2012.3.1024 (http://kendoui.com)
* Copyright 2012 Telerik AD. All rights reserved.
*
* Kendo UI Beta license terms available at
* http://www.kendoui.com/purchase/license-agreement/kendo-ui-beta.aspx
*/

;(function(e,t){function b(t){return e.trim(t).replace(/&nbsp;/gi,"")}var n=window.kendo,r=n.ui,i=e.proxy,s=e.extend,o=e.grep,u=e.map,a=e.inArray,f="k-state-selected",l="asc",c="desc",h="change",p="kendoPopup",d="kendoFilterMenu",v="kendoMenu",m=".kendoColumnMenu",g=/(\[|\]|\$|\.|\:|\+)/g,y=r.Widget,w=y.extend({init:function(t,r){var s=this,o;y.fn.init.call(s,t,r),t=s.element,r=s.options,s.owner=r.owner,s.dataSource=r.dataSource,s.field=t.attr(n.attr("field")),o=t.find(".k-header-column-menu"),o[0]||(o=t.prepend('<a class="k-header-column-menu" href="#"><span class="k-icon k-i-arrowhead-s"/></a>').find(".k-header-column-menu")),s.link=o.attr("tabindex",-1).on("click"+m,i(s._click,s)),s.wrapper=e('<div class="k-column-menu"/>'),s.wrapper.html(n.template(E)({ns:n.ns,messages:r.messages,sortable:r.sortable,filterable:r.filterable,columns:s._ownerColumns(),showColumns:r.columns})),s.popup=s.wrapper[p]({anchor:o,open:i(s._open,s),activate:i(s._activate,s),close:s.options.closeCallback}).data(p),s._menu(),s._sort(),s._columns(),s._filter()},options:{name:"ColumnMenu",messages:{sortAscending:"Sort Ascending",sortDescending:"Sort Descending",filter:"Filter",columns:"Columns"},columns:!0,sortable:!0,filterable:!0},destroy:function(){var e=this;y.fn.destroy.call(e),e.filterMenu&&e.filterMenu.destroy(),e.dataSource.unbind("refresh",e._refreshHandler),e.options.columns&&(e.owner.unbind("columnShow",e._updateColumnsMenuHandler),e.owner.unbind("columnHide",e._updateColumnsMenuHandler)),e.menu.element.off(m),e.menu.destroy(),e.wrapper.off(m),e.popup.destroy(),e.link.off(m)},close:function(){this.menu.close(),this.popup.close(),this.popup.element.off("keydown"+m)},_click:function(e){e.preventDefault(),e.stopPropagation(),this.popup.toggle()},_open:function(){var t=this;e(".k-column-menu").not(t.wrapper).each(function(){e(this).data(p).close()}),t.popup.element.on("keydown"+m,function(e){e.keyCode==n.keys.ESC&&t.close()})},_activate:function(){this.menu.element.focus()},_ownerColumns:function(){var e=this.owner.columns,t=o(e,function(e){var t=!0,n=b(e.title||"");if(e.menu===!1||!e.field&&!n.length)t=!1;return t});return u(t,function(t){return{field:t.field||t.title,title:t.title||t.field,hidden:t.hidden,index:a(t,e)}})},_menu:function(){this.menu=this.wrapper.children()[v]({orientation:"vertical",closeOnClick:!1}).data(v)},_sort:function(){var t=this;t.options.sortable&&(t.refresh(),t._refreshHandler=i(t.refresh,t),t.dataSource.bind(h,t._refreshHandler),t.menu.element.on("click"+m,".k-sort-asc, .k-sort-desc",function(){var n=e(this),r=n.hasClass("k-sort-asc")?l:c;n.parent().find(".k-sort-"+(r==l?c:l)).removeClass(f),t._sortDataSource(n,r),t.close()}))},_sortDataSource:function(e,n){var r=this,i=r.options.sortable,s=r.dataSource,o,u,a=s.sort()||[];e.hasClass(f)&&i&&i.allowUnsort!==!1?(e.removeClass(f),n=t):e.addClass(f);if(i===!0||i.mode==="single")a=[{field:r.field,dir:n}];else{for(o=0,u=a.length;o<u;o++)if(a[o].field===r.field){a.splice(o,1);break}a.push({field:r.field,dir:n})}s.sort(a)},_columns:function(){var t=this;t.options.columns&&(t._updateColumnsMenu(),t._updateColumnsMenuHandler=i(t._updateColumnsMenu,t),t.owner.bind(["columnHide","columnShow"],t._updateColumnsMenuHandler),t.menu.bind("select",function(r){var i=e(r.item),s,u,f,l=t.owner.columns,c;if(!i.parent().closest("li.k-columns-item")[0])return;s=i.find(":checkbox"),c=s.attr(n.attr("field")),f=o(l,function(e){return e.field==c||e.title==c})[0],u=a(f,l),f.hidden===!0?t.owner.showColumn(u):t.owner.hideColumn(u)}))},_updateColumnsMenu:function(){var e="["+n.attr("field")+"=",t=this._ownerColumns(),r=u(t,function(t){return e+t.field.replace(g,"\\$1")+"]"}).join(","),i=o(t,function(e){return!e.hidden}),s=u(i,function(t){return e+t.field.replace(g,"\\$1")+"]"}).join(",");this.wrapper.find(r).attr("checked",!1),this.wrapper.find(s).attr("checked",!0).attr("disabled",i.length==1)},_filter:function(){var e=this,t=e.options;t.filterable!==!1&&(e.filterMenu=e.wrapper.find(".k-filterable")[d](s(!0,{},{appendToElement:!0,dataSource:t.dataSource,values:t.values,field:e.field},t.filterable)).data(d))},refresh:function(){var e=this,t=e.options.dataSource.sort()||[],n,r=e.field,i,s;e.wrapper.find(".k-sort-asc, .k-sort-desc").removeClass(f);for(i=0,s=t.length;i<s;i++)n=t[i],r==n.field&&e.wrapper.find(".k-sort-"+n.dir).addClass(f)}}),E='<ul>#if(sortable){#<li class="k-item k-sort-asc"><span class="k-link"><span class="k-sprite k-i-sort-asc"></span>${messages.sortAscending}</span></li><li class="k-item k-sort-desc"><span class="k-link"><span class="k-sprite k-i-sort-desc"></span>${messages.sortDescending}</span></li>#if(showColumns || filterable){#<li class="k-separator"></li>#}##}##if(showColumns){#<li class="k-item k-columns-item"><span class="k-link"><span class="k-sprite k-i-columns"></span>${messages.columns}</span><ul>#for (var col in columns) {#<li><input type="checkbox" data-#=ns#field="#=columns[col].field#" data-#=ns#index="#=columns[col].index#"/>#=columns[col].title#</li>#}#</ul></li>#if(filterable){#<li class="k-separator"></li>#}##}##if(filterable){#<li class="k-item k-filter-item"><span class="k-link"><span class="k-sprite k-filter"></span>${messages.filter}</span><ul><li><div class="k-filterable"></div></li></ul></li>#}#</ul>';r.plugin(w)})(jQuery);