/*
* Kendo UI Beta v2012.3.1024 (http://kendoui.com)
* Copyright 2012 Telerik AD. All rights reserved.
*
* Kendo UI Beta license terms available at
* http://www.kendoui.com/purchase/license-agreement/kendo-ui-beta.aspx
*/

;(function(e,t){var n=window.kendo,r="change",i="dataBound",s="dataBinding",o=n.ui.Widget,u=n.keys,a=">*",f="requestStart",l="error",c="k-state-focused",h="k-state-selected",p="k-edit-item",d="string",v="edit",m="remove",g="save",y="click",b=".kendoListView",w=e.proxy,E=n.ui.progress,S=n.data.DataSource,x=o.extend({init:function(t,r){var i=this;r=e.isArray(r)?{dataSource:r}:r,o.fn.init.call(i,t,r),r=i.options,i.wrapper=t=i.element,t[0].id&&(i._itemId=t[0].id+"_lv_active"),i._element(),i._dataSource(),i.template=n.template(r.template||""),i.altTemplate=n.template(r.altTemplate||r.template),i.editTemplate=n.template(r.editTemplate||""),i._navigatable(),i._selectable(),i._pageable(),i._crudHandlers(),i.options.autoBind&&i.dataSource.fetch(),n.notify(i)},events:[r,s,i,v,m,g],options:{name:"ListView",autoBind:!0,selectable:!1,navigatable:!1,template:"",altTemplate:"",editTemplate:""},_item:function(e){return this.element.children()[e]()},items:function(){return this.element.children()},setDataSource:function(e){this.options.dataSource=e,this._dataSource(),this.options.autoBind&&e.fetch()},_unbindDataSource:function(){var e=this;e.dataSource.unbind(r,e._refreshHandler).unbind(f,e._requestStartHandler).unbind(l,e._errorHandler)},_dataSource:function(){var e=this;e.dataSource&&e._refreshHandler?e._unbindDataSource():(e._refreshHandler=w(e.refresh,e),e._requestStartHandler=w(e._requestStart,e),e._errorHandler=w(e._error,e)),e.dataSource=S.create(e.options.dataSource).bind(r,e._refreshHandler).bind(f,e._requestStartHandler).bind(l,e._errorHandler)},_requestStart:function(){E(this.element,!0)},_error:function(){E(this.element,!1)},_element:function(){this.element.addClass("k-widget k-listview").attr("role","listbox")},refresh:function(t){var r=this,o=r.dataSource.view(),u,a,f,l="",c,h,p=r.template,d=r.altTemplate;if(t&&t.action==="itemchange"){r.editable||(u=t.items[0],c=e.inArray(u,o),c>=0&&(f=e(p(u)),r.items().eq(c).replaceWith(f),r.trigger("itemChange",{item:f,data:u})));return}t=t||{};if(r.trigger(s,{action:t.action||"rebind",items:t.items,index:t.index}))return;r._destroyEditable();for(c=0,h=o.length;c<h;c++)c%2?l+=d(o[c]):l+=p(o[c]);r.element.html(l),a=r.items();for(c=0,h=o.length;c<h;c++)a.eq(c).attr(n.attr("uid"),o[c].uid).attr("role","option").attr("aria-selected","false");r.element[0]===document.activeElement&&r.options.navigatable&&r.current(a.eq(0)),r.trigger(i)},_pageable:function(){var t=this,r=t.options.pageable,i,s;e.isPlainObject(r)&&(s=r.pagerId,i=e.extend({},r,{dataSource:t.dataSource,pagerId:null}),t.pager=new n.ui.Pager(e("#"+s),i))},_selectable:function(){var e=this,t,i,s=e.options.selectable,o=e.options.navigatable;s&&(t=typeof s===d&&s.toLowerCase().indexOf("multiple")>-1,t&&e.element.attr("aria-multiselectable",!0),e.selectable=new n.ui.Selectable(e.element,{aria:!0,multiple:t,filter:a,change:function(){e.trigger(r)}}),o&&e.element.on("keydown"+b,function(n){if(n.keyCode===u.SPACEBAR){i=e.current(),n.target==n.currentTarget&&n.preventDefault();if(t){if(!n.ctrlKey)e.selectable.clear();else if(i&&i.hasClass(h)){i.removeClass(h);return}}else e.selectable.clear();e.selectable.value(i)}}))},current:function(e){var n=this,r=n.element,i=n._current;if(e===t)return i;i&&(i.removeClass(c).removeAttr("id"),r.removeAttr("aria-activedescendant")),e&&e[0]&&(n._scrollTo(e[0]),r.attr("aria-activedescendant",n._itemId),e.addClass(c).attr("id",n._itemId)),n._current=e},_scrollTo:function(t){var n=this,r,i=!1,s="scroll";n.wrapper.css("overflow")=="auto"||n.wrapper.css("overflow")==s?r=n.wrapper[0]:(r=window,i=!0);var o=function(n,o){var u=i?e(t).offset()[n.toLowerCase()]:t["offset"+n],a=t["client"+o],f=e(r)[s+n](),l=e(r)[o.toLowerCase()]();u+a>f+l?e(r)[s+n](u+a-l):u<f&&e(r)[s+n](u)};o("Top","Height"),o("Left","Width")},_navigatable:function(){var t=this,r=t.options.navigatable,i=t.element,s=function(n){t.current(e(n.currentTarget)),e(n.target).is(":button,a,:input,a>.k-icon,textarea")||i.focus()};r&&(t._tabindex(),i.on("focus"+b,function(){var e=t._current;if(!e||!e.is(":visible"))e=t._item("first");t.current(e)}).on("focusout"+b,function(){t._current&&t._current.removeClass(c)}).on("keydown"+b,function(r){var s=r.keyCode,o=t._current,a=!e(r.target).is(":button,textarea,a,a>.t-icon"),f=n.preventDefault,l=i.find("."+p),c;if(!a&&u.ESC!=s)return;if(u.UP===s||u.LEFT===s)o&&(o=o.prev()),t.current(!o||!o[0]?t._item("first"):o),f(r);else if(u.DOWN===s||u.RIGHT===s)o&&(o=o.next()),t.current(!o||!o[0]?t._item("first"):o),f(r);else if(u.PAGEUP===s)t.current(null),t.dataSource.page(t.dataSource.page()-1),f(r);else if(u.PAGEDOWN===s)t.current(null),t.dataSource.page(t.dataSource.page()+1),f(r);else if(u.HOME===s)t.current(t._item("first")),f(r);else if(u.END===s)t.current(t._item("last")),f(r);else if(u.ENTER===s)if(l.length!==0&&a){c=t.items().index(l),document.activeElement.blur(),t.save();var h=function(){t.element.trigger("focus"),t.current(t.items().eq(c))};t.one("dataBound",h)}else t.options.editTemplate!==""&&(t.current(null),t.edit(o));else if(u.ESC===s){l=i.find("."+p);if(l.length===0)return;c=t.items().index(l),t.cancel(),t.element.trigger("focus"),t.current(t.items().eq(c))}}),i.on("mousedown"+b,a,w(s,t)))},clearSelection:function(){var e=this;e.selectable.clear(),e.trigger(r)},select:function(t){var n=this,r=n.selectable;t=e(t);if(t.length){r.options.multiple||(r.clear(),t=t.first()),r.value(t);return}return r.value()},_destroyEditable:function(){var e=this;e.editable&&(e.editable.destroy(),delete e.editable)},_modelFromElement:function(e){var t=e.attr(n.attr("uid"));return this.dataSource.getByUid(t)},_closeEditable:function(t){var r=this,i=r.editable,s,o,u=!0;return i&&(t&&(u=i.end()),u&&(s=r._modelFromElement(i.element),o=e(r.template(s)).attr(n.attr("uid"),s.uid),r._destroyEditable(),i.element.replaceWith(o))),u},edit:function(t){var r=this,i=r._modelFromElement(t),s=e(r.editTemplate(i)).addClass(p);r.cancel(),s.attr(n.attr("uid"),i.uid),t.replaceWith(s),r.editable=s.kendoEditable({model:i,clearContainer:!1,errorTemplate:!1}).data("kendoEditable"),r.trigger(v,{model:i,item:s})},save:function(){var e=this,t=e.editable.element,n=e._modelFromElement(t);!e.trigger(g,{model:n,item:t})&&e._closeEditable(!0)&&e.dataSource.sync()},remove:function(e){var t=this,n=t.dataSource,r=t._modelFromElement(e);t.trigger(m,{model:r,item:e})||(e.hide(),n.remove(r),n.sync())},add:function(){var e=this,t=e.dataSource,n=t.indexOf((t.view()||[])[0]);n<0&&(n=0),e.cancel(),t.insert(n,{}),e.edit(e.element.children().first())},cancel:function(){var e=this,t=e.dataSource;e.editable&&(t.cancelChanges(e._modelFromElement(e.editable.element)),e._closeEditable(!1))},_crudHandlers:function(){var t=this,r=y+b;t.element.on(r,".k-edit-button",function(r){var i=e(this).closest("["+n.attr("uid")+"]");t.edit(i),r.preventDefault()}),t.element.on(r,".k-delete-button",function(r){var i=e(this).closest("["+n.attr("uid")+"]");t.remove(i),r.preventDefault()}),t.element.on(r,".k-update-button",function(e){t.save(),e.preventDefault()}),t.element.on(r,".k-cancel-button",function(e){t.cancel(),e.preventDefault()})},destroy:function(){var e=this;o.fn.destroy.call(e),e._unbindDataSource(),e._destroyEditable(),e.element.off(b),e.pager&&e.pager.destroy(),e.selectable&&e.selectable.destroy(),n.destroy(e.element)}});n.ui.plugin(x)})(jQuery);